<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8,IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>bookroles.com</title>
    <link rel="shortcut icon" href="./image/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="./bootstrap-icons/font/bootstrap-icons.min.css">
    <script type="text/javascript" src="./js/jquery-3.7.1.min.js"></script>
    <script type="text/javascript" src="./js/bootstrap.min.js"></script>
    <script type="text/javascript" src="./js/base64.js"></script>
    <script type="text/javascript" src="./js/crypto-js2.min.js"></script>

    <style type="text/css">
        @font-face{
            font-family: bookroles1;
            src:url('css/bookroles1.ttf');
        }
        body{
            background-color: #EEEEEE;
        }
        .top-search{
            padding: 0.5rem 0;
            opacity:0.9;
        }
        .card{
            margin-bottom: 5px;
            font-family: bookroles1;
        }
        button{
            font-family: bookroles1;
        }
        .modal-dialog{
            font-family: bookroles1;
        }
        .card .card-img-top{
            width: 255px;
            height: 340px;
        }
        .card .content-intro{
            border: 1px solid #EEEEEE;
        }
    </style>
</head>
<body style="display: none;">
    <div id="header" class="top-search container sticky-top bg-white"></div>
    <div class="container card">
        <div class="card-body">
            <h3 class="card-title"><b><a href="javascript:void(0);" id="titleBookName" style="color:black;"></a></b></h3>
            <b class="linkAuthor"></b>
            <i class="bi bi-houses"></i>
            <a href="javascript:void(0);" class="card-link text-info"><span id="linkPublishHouse"></span></a>
            <i class="bi bi-archive"></i>
            <a href="javascript:void(0);" class="card-link text-info"><span id="linkArchiveType"></span></a>
        </div>
        <div class="row no-gutters">
            <div class="col-lg-3 text-left">
                <img id="imgUrl" rel="prefetch" class="card-img-top img-fluid img-thumbnail" src="./image/bgbook.jpg" title="">
            </div>
            <div class="col-lg-4" style="background-color: #EEEEEE;">
                <div class="card-body card-detail-row">
                    <p class="card-text"><span class="w-50 p-2" title="出版日期"><i class="bi bi-calendar3"></i><b> 出版日期:</b></span><span id="publishMonth"></span></p>
                    <p class="card-text"><span class="w-50 p-2" title="本站书籍评分"><i class="bi bi-list-stars"></i><b> 书籍评分:</b></span><span id="score" style="color:goldenrod;"></span></p>
                    <p class="card-text"><span class="w-50 p-2" title="本站上传时间"><i class="bi bi-arrow-up-square"></i><b> 上传时间:</b></span><span id="uploadTime"></span></p>
                    <p class="card-text"><span class="w-50 p-2" title="本站下载格式"><i class="bi bi-arrow-down-square"></i><b> 下载格式:</b></span><span id="downloadFormat"></span></p>
                    <p class="card-text"><span class="w-50 p-2" title="本站查询次数"><i class="bi bi-search-heart-fill"></i><b> 查询次数:</b></span><span id="searchCount"></span></p>
                    <p class="card-text"><span class="w-50 p-2" title="本站最近查询时间"><i class="bi bi-search-heart-fill"></i><b> 查询时间:</b></span><span id="searchTime"></span></p>
                    <p class="card-text"><span class="w-50 p-2" title="本站下载次数"><i class="bi bi-cloud-download-fill"></i><b> 下载次数:</b></span><span id="downloadCount"></span></p>
                    <p class="card-text"><span class="w-50 p-2" title="本站最近下载时间"><i class="bi bi-cloud-download-fill"></i><b> 下载时间:</b></span><span id="downloadTime"></span></p>
                </div>
            </div>
        </div>
        <div class="card-body content-intro">
            <h5 class="card-title"><b>简介</b></h5>
            <p class="card-text">

            </p>
        </div>
        <div class="card-body" id="validCodeBody" style="visibility: hidden;">
            <h5 class="card-title"><b>下载地址</b></h5>
            <button type="button" class="btn btn-secondary btn-lg btn-block" id="downBtn" data-toggle="modal" data-target="#validCodeModal">点击获得地址</button>
        </div>
    </div>

    <div class="modal fade" id="validCodeModal" tabindex="-1" role="dialog" aria-labelledby="validCodeModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="validCodeModallLabel">下载地址</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="input-group" id="validCodeGroup">
                        <label for="validCodeInput" class="col-form-label">验证码:&nbsp;&nbsp;</label>
                        <input id="validCodeInput" class="form-control" type="text" placeholder="验证码">
                        <canvas id="canvas" width="100px" height="40px"></canvas>
                        <button id="validCodeBtn" class="btn btn-info" type="submit" data-valide-code="">验证</button>
                    </div>
                    <a id="bookAddress" style="display: none;" target="_blank" href="javascript:void(0);" class="card-link"></a>
                    <i id="validCodeInputHint" style="visibility: hidden" class="bi bi-bag-x-fill text-danger"></i>
                </div>
            </div>
        </div>
    </div>
    <div id="footer"></div>


    <script type="text/javascript">

        const key = "a90e7d2eb24c4b8b88994ab065e377d3";
        const iv = "bookrolesABcDEFh";
        function encrypt(content) {
            return CryptoJS.AES.encrypt(content, CryptoJS.enc.Utf8.parse(key),{
                iv: CryptoJS.enc.Utf8.parse(iv),
                mode: CryptoJS.mode.CBC,
                padding: CryptoJS.pad.Pkcs7
            }).toString();
        }

        function decrypt(content) {
            let decrypted = CryptoJS.AES.decrypt(content, CryptoJS.enc.Utf8.parse(key), {
                iv: CryptoJS.enc.Utf8.parse(iv),
                mode: CryptoJS.mode.CBC,
                padding: CryptoJS.pad.Pkcs7
            });
            return decrypted.toString(CryptoJS.enc.Utf8);
        }

        function timestampToDateTime(timestamp){
            // 此处时间戳以毫秒为单位
            let date = new Date(parseInt(timestamp));
            let Year = date.getFullYear();
            let Moth = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1);
            let Day = (date.getDate() < 10 ? '0' + date.getDate() : date.getDate());
            let Hour = (date.getHours() < 10 ? '0' + date.getHours() : date.getHours());
            let Minute = (date.getMinutes() < 10 ? '0' + date.getMinutes() : date.getMinutes());
            return Year + '/' + Moth + '/' + Day + '   '+ Hour +':'+ Minute;
        }

        function headerSearch(){
            let word = $("#headerSearchInput").val().trim();
            if(word && word != "null"){
                let url = "./home.html?module=search&word="+ encodeURIComponent(word);
                window.open(url);
            }
            return;
        }
        function openSearchAuthor(author){
            if(author && author != "null"){
                let url = "./home.html?module=author&author="+ encodeURIComponent(author);
                window.open(url);
            }
        }
        function GetQueryString(name){
            var search = window.location.search;
            if(search && search.indexOf("?") != -1 ){
                var wordVal = search.split("?")[1].split(name)[1];
                if(wordVal){
                    return decodeURIComponent(wordVal.substr(1));
                }
            }
            return null;
        }

        function starStr(score){
            let fill_star = "<i class=\"bi bi-star-fill\">";
            let half_star = "<i class=\"bi bi-star-half\">";
            let empty_star = "<i class=\"bi bi-star\">";
            let str = "";
            let has_half = false;
            if((score / .5) % 2){has_half = true;}
            for(let i = 0;i < 5; i++){
                if(i < score){
                    if(has_half && i == Math.floor(score)){
                        str += half_star;
                    }else{
                        str += fill_star;
                    }
                }else{
                    str += empty_star
                }

            }
            return str;
        }

        function randomNum(min,max){return Math.floor(Math.random()*(max-min)+min);}
        function randomColor(min,max){
            var _r = randomNum(min,max);
            var _g = randomNum(min,max);
            var _b = randomNum(min,max);
            return "rgb("+_r+","+_g+","+_b+")";
        }
        function drawPic(){
            var $canvas = document.getElementById("canvas");
            var _str = "0123456789";
            var _picTxt = "";
            var _num = 4;
            var _width = $canvas.width;
            var _height = $canvas.height;
            var ctx = $canvas.getContext("2d");//获取 context 对象
            ctx.textBaseline = "bottom";//文字上下对齐方式--底部对齐
            ctx.fillStyle = randomColor(180,240);//填充画布颜色
            ctx.fillRect(0,0,_width,_height);
            for(var i=0; i<_num; i++){
                var x = (_width-10)/_num*i+10;
                var y = randomNum(_height/2,_height);
                var deg = randomNum(-45,45);
                var txt = _str[randomNum(0,_str.length)];
                _picTxt += txt;//获取一个随机数
                ctx.fillStyle = randomColor(10,100);//填充随机颜色
                ctx.font = randomNum(16,40)+"px SimHei";//设置随机数大小，字体为SimHei
                ctx.translate(x,y);//将当前xy坐标作为原始坐标
                ctx.rotate(deg*Math.PI/180);//旋转随机角度
                ctx.fillText(txt, 0,0);//绘制填色的文本
                ctx.rotate(-deg*Math.PI/180);
                ctx.translate(-x,-y);
            }
            for(var i=0; i<_num; i++){//定义笔触颜色
                ctx.strokeStyle = randomColor(90,180);
                ctx.beginPath();//随机划线--4条路径
                ctx.moveTo(randomNum(0,_width), randomNum(0,_height));
                ctx.lineTo(randomNum(0,_width), randomNum(0,_height));
                ctx.stroke();
            }
            for(var i=0; i<_num*10; i++){
                ctx.fillStyle = randomColor(0,255);
                ctx.beginPath();//随机画原，填充颜色
                ctx.arc(randomNum(0,_width),randomNum(0,_height), 1, 0, 2*Math.PI);
                ctx.fill();
            }
            $("#validCodeBtn").attr("data-valide-code",_picTxt);
            return;
        };

        $(function(){
            loadEvent();
            runEvent();
            function loadEvent(){

                $("#titleBookName").on("click",function(){
                    $("#headerSearchInput").val($(this).html());
                });

                $("#titleBookName").on("dblclick",function(){
                    if($(this).html()){
                        $("#headerSearchBtn").trigger("click");
                    }
                });

                $("#linkPublishHouse").on("click",function(){
                    $("#headerSearchInput").val($(this).html());
                });

                $("#linkPublishHouse").on("dblclick",function(){
                    if($(this).html()){
                        $("#headerSearchBtn").trigger("click");
                    }
                });

                $("#linkArchiveType").on("click",function () {
                    let archiveTypeId = $(this).attr("archiveTypeId");
                    if(archiveTypeId){
                        let url = "./home.html?module=archiveType&id="+ archiveTypeId;
                        window.open(url);
                    }
                });

                $("#downBtn").on("click",function(){
                    drawPic();
                });

                $("#validCodeBtn").on("click",function(){
                    let inputCode = $("#validCodeInput").val();
                    if(!inputCode){
                        $("#validCodeInputHint").html("验证码不能为空").removeClass("text-info").addClass("text-danger").css("visibility","visible");
                        return;
                    }
                    if($(this).attr("data-valide-code") == inputCode){
                        let id = GetQueryString("id");
                        if(!id) return;
                        let param = {};
                        if(id){ param.id = id };
                        let jParam = JSON.stringify(param)
                        param = encrypt(jParam);
                        $.post("/bookroles/book/getDownLoadUrl.do",param,function(result,status){
                            let resultData = "";
                            if(decrypt(result).trim()){
                                resultData = JSON.parse(decrypt(result));
                            }
                            if(status == "success"){
                                $("#validCodeGroup").hide();
                                // let address = new Base64().decode(result.download_url);
                                $("#bookAddress").attr("href",resultData).html(resultData).fadeIn();
                            }else{
                                console.log("加载失败");
                            }
                        });
                    }else{
                        $("#validCodeInputHint").html("验证码输入错误，请重新输入").removeClass("text-info").addClass("text-danger").css("visibility","visible");
                        drawPic();
                    }
                });

                $("#validCodeInput").change(function(e){
                    let inputCode = $("#validCodeInput").val();
                    let validCode = $("#validCodeBtn").attr("data-valide-code");
                    if(validCode == inputCode){
                        $("#validCodeInputHint").html("验证成功，点击地址进入").removeClass("text-danger").addClass("text-info").css("visibility","visible");
                    }else{
                        $("#validCodeInputHint").html("验证码输入错误，请重新输入").removeClass("text-info").addClass("text-danger").css("visibility","visible");
                    }
                });

                $("#canvas").on("click",function(e){
                    e.preventDefault();
                    drawPic();
                });
            }

            function getContent(){
                let id = GetQueryString("id");
                if(!id) return;
                let param = {};
                if(id){ param.id = id };
                let jParam = JSON.stringify(param)
                param = encrypt(jParam);
                $.ajax({
                    url: "/bookroles/book/getById.do",
                    type: 'post',
                    data: param,
                    async: false,
                    success: function(result){
                        let resultData = "";
                        if(decrypt(result).trim()){
                            resultData = JSON.parse(decrypt(result));
                        }
                        showContent(resultData);
                    },
                    error: function(){
                        console.log('加载失败');
                    }
                });
            }

            function showContent(resultData){
                if(resultData.image){
                    $("#imgUrl").attr("src","./image/"+resultData.image);
                }
                $("#imgUrl").attr("title",resultData.name);
                $("#titleBookName").html(resultData.name);
                $("#linkArchiveType").html(resultData.archive_type_name).attr("archiveTypeId",resultData.archive_type_id);
                let linkAuthorDomStr = "";
                if(resultData.author) {
                    $.each(resultData.author.split(" "), function (index, str) {
                        linkAuthorDomStr += "<i class=\'bi bi-file-person\'></i><a href=\'javascript:void(0);\' class=\'card-link text-info\' onclick='openSearchAuthor(" + "\"" + str + "\"" + ")'><span>" + str + "</span></a>"
                    });
                }
                $(".linkAuthor").html(linkAuthorDomStr);
                $("#linkPublishHouse").html(resultData.publish_house);
                $("#publishHouse").html(resultData.publish_house);
                $("#publishMonth").html(resultData.publish_month);
                $("#score").html(starStr(resultData.score)).attr("title",resultData.score);
                $("#uploadTime").html(resultData.upload_time);
                $("#downloadFormat").html(resultData.download_format);
                $("#archiveType").html(resultData.archive_type_name);
                $("#author").html(resultData.author);
                $("#searchCount").html(resultData.search_count);
                if(resultData.search_time && resultData.search_time > 0){
                    $("#searchTime").html(timestampToDateTime(resultData.search_time));
                }else{
                    $("#searchTime").html("无");
                }
                $("#downloadCount").html(resultData.download_count);
                if(resultData.download_time && resultData.download_time > 0){
                    $("#downloadTime").html(timestampToDateTime(resultData.download_time));
                }else{
                    $("#downloadTime").html("无");
                }
                $(".content-intro .card-text").html(resultData.content_intro);
                $("#validCodeBody").css("visibility","visible");
            }

            function runEvent(){
                $("#header").load("./header.html");
                getContent();
                $("body").fadeIn(1000);
                $("#footer").load("./footer.html");
            };
        });

    </script>
</body>
</html>
